0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
hist(y)
hist(y,breaks=20)
## compare histograms of y & estimated y
par(mfrow=c(2,1))
hist(y,breaks=20,main="histogram of true liabilities")
hist(est.y[1:Ntip(tree)],breaks=20,
main="histogram of estimated liabilities")
## compare histograms of y & estimated y
par(mfrow=c(2,1))
hist(y,breaks=20,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=20,
main="histogram of estimated liabilities",
xlab="estimated liability")
## simulate star-shaped tree
tree<-phytools:::lambdaTree(pbtree(n=100),0)
## simulate liabilities
y<-fastBM(tree)
## simulate threshold trait
x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
hist(y,breaks=20,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=20,
main="histogram of estimated liabilities",
xlab="estimated liability")
breaks<-seq(min(y),max(y),length.out=20)
breaks<-seq(min(y),max(y),length.out=20)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
## load phytools
library(phytools)
## simulate tree
tree<-pbtree(n=500)
## simulate liabilities
y<-fastBM(tree)
## simulate threshold trait
x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(min(y),max(y),length.out=30)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=30)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
fit$mk_fit
breaks<-seq(min(y),max(y),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(min(y),max(y),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
par(mfrow=c(2,1))
breaks<-seq(min(y),max(y),length.out=32)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
breaks
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=30)
breaks
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
breaks
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8,col="blue",lwd=2)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8,col="blue",lwd=2)
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
## load phytools
library(phytools)
## simulate tree
tree<-pbtree(n=500)
## simulate liabilities
y<-fastBM(tree)
## simulate threshold trait
x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
## now do the same thing without information about
## the liability (i.e., on a star tree)
## simulate star-shaped tree
tree<-phytools:::lambdaTree(pbtree(n=100),0)
## simulate liabilities
y<-fastBM(tree)
## simulate threshold trait
x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
library(phytools)
data("elapidae.tree")
par(mfrow=c(2,1))
plotTree(elapidae.tree,ftype='i',fsize=0.6)
par(mfrow=c(2,1))
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1)
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1,
mar=c(2.1,4.1,1.1,1.1))
par(mfrow=c(2,1))
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1,
mar=c(2.1,4.1,1.1,1.1))
object<-ltt(elapidae.tree,plot=FALSE)
object
plot(object,mar=c(5.1,4.1,1.1,1.1),bty="n",las=1,log.lineages=FALSE)
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1,
mar=c(2.1,4.1,1.1,1.1))
pp<-get("last_plot.phylo",envir=.PlotPhyloEnv)
plot(object,mar=c(5.1,4.1,1.1,1.1),bty="n",las=1,log.lineages=FALSE,)
plot(object,mar=c(5.1,4.1,1.1,1.1),bty="n",las=1,log.lineages=FALSE,
xlim=pp$x.lim)
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1,
mar=c(2.1,4.1,1.1,1.1))
par(mar=c(5.1,4.1,1.1,1.1))
plot(object,mar=c(5.1,4.1,1.1,1.1),bty="n",las=1,log.lineages=FALSE,
xlim=pp$x.lim)
## load phytools
library(phytools)
## load primate trees
primates_trees<-read.nexus(
file="https://liamrevell.github.io/biol634/data/10kTrees_Primates.nex")
primate_trees
rm(list=ls())
## load phytools
library(phytools)
## load primate trees
primate_trees<-read.nexus(
file="https://liamrevell.github.io/biol634/data/10kTrees_Primates.nex")
primate_trees
## compute one tree from this set: the MCC tree
library(phangorn)
?maxCladeCred
primate_mcc<-maxCladeCred(primate_trees)
primate_mcc
## let's plot this tree
plotTree(primate_mcc,ftype="i",fsize=0.5)
## let's plot this tree
plotTree(primate_mcc,ftype="i",fsize=0.5,type="fan")
## let's plot this tree
plotTree(primate_mcc,ftype="i",fsize=0.5,type="fan",
lwd=1)
## how many primates are there?
nlow<-376
nhigh<-524
primates_bd.low<-fit.bd(primate_mcc,
rho=Ntip(primate_mcc)/nlow)
## how many primates are there?
nlow<-376
nhigh<-524
primates_bd.low<-fit.bd(primate_mcc,
rho=Ntip(primate_mcc)/nlow)
ploTree(primate_mcc,ftype="off",lwd=1)
plotTree(primate_mcc,ftype="off",lwd=1)
?force.ultrametric
?force.ultrametric
## apply force.ultrametric
primate_mcc<-force.ultrametric(primate_mcc)
## now run our bd model
primates_bd.low<-fit.bd(primate_mcc,
rho=Ntip(primate_mcc)/nlow)
primates_bd.low
primates_bd.high<-fit.bd(primate_mcc,
rho=Ntip(primate_mcc)/nhigh)
primates_bd.high
n_unrealistic
n_unrealistic<-1000
fit.bd(primate_mcc,
rho=Ntip(primate_mcc)/n_unrealistic)
getwd()
setwd("../Desktop/")
## download files
download.file(
url="https://liamrevell.github.io/biol634/data/grunts.csv",
destfile="grunts.csv")
download.file(
url="https://liamrevell.github.io/biol634/data/grunts.phy",
destfile="grunts.phy")
## let's read our tree from file
grunt_tree<-read.tree(file="grunts.phy")
grunt_tree
## get our data
grunt_data<-read.csv(file="grunts.csv",row.names=1)
head(grunt_data)
## pull out habitat
grunt_habitat<-setNames(grunt_data$habitat,
rownames(grunt_data))
head(grunt_habitat)
## plot our tree
plotTree(grunt_tree,ftype="i",fsize=0.7,
offset=0.5)
## plot our tree
plotTree(grunt_tree,ftype="i",fsize=0.8,
offset=0.5)
to.matrix(habitat,0:1)
to.matrix(grunt_habitat,0:1)
to.matrix(grunt_habitat,0:1)[grunt_tree$tip.label,]
tiplabels(pie=to.matrix(grunt_habitat,0:1)[grunt_tree$tip.label,])
## plot our tree
plotTree(grunt_tree,ftype="i",fsize=0.8,
offset=0.5)
tiplabels(
pie=to.matrix(grunt_habitat,0:1)[grunt_tree$tip.label,],
cex=0.5,piecol=hcl.colors(n=2))
## plot our tree
plotTree(grunt_tree,ftype="i",fsize=0.8,
offset=0.5)
tiplabels(
pie=to.matrix(grunt_habitat,0:1)[grunt_tree$tip.label,],
cex=0.4,piecol=hcl.colors(n=2))
head(grunt_data)
legend("bottomleft",c("non-reef","reef"),pch=21,
bg=hcl.colors(n=2))
## plot our tree
plotTree(grunt_tree,ftype="i",fsize=0.8,
offset=0.5)
tiplabels(
pie=to.matrix(grunt_habitat,0:1)[grunt_tree$tip.label,],
cex=0.4,piecol=hcl.colors(n=2))
legend("bottomleft",c("non-reef","reef"),pch=21,
pt.bg=hcl.colors(n=2))
## plot our tree
plotTree(grunt_tree,ftype="i",fsize=0.8,
offset=0.5)
tiplabels(
pie=to.matrix(grunt_habitat,0:1)[grunt_tree$tip.label,],
cex=0.4,piecol=hcl.colors(n=2))
legend("bottomleft",c("non-reef","reef"),pch=21,
pt.bg=hcl.colors(n=2),pt.cex=2,bty="n")
library(diversitree)
## make our BiSSE likelihood function
grunt_bisse.fn<-make.bisse(grunt_tree,grunt_habitat)
grunt_bisse.fn
## let's get starting values for optimization
starting_p<-starting.point.bisse(grunt_tree)
starting_p
## let's get our total tree height
max(nodeHeights(grunt_tree))
## get our total tree height
h<-max(nodeHeights(grunt_tree))
h
rescaled.grunt_tree$edge.length<-rescaled.grunt_tree$edge.length/h*45
rescaled.grunt_tree<-grunt_tree
rescaled.grunt_tree$edge.length<-rescaled.grunt_tree$edge.length/h*45
## let's check if it worked!
plotTree(rescaled.grunt_tree,mar=c(3.1,1.1,1.1,1.1))
axis(1)
## make our BiSSE likelihood function
grunt_bisse.fn<-make.bisse(rescaled.grunt_tree,
grunt_habitat)
grunt_bisse.fn
## let's get starting values for optimization
starting_p<-starting.point.bisse(rescaled.grunt_tree)
starting_p
##
fit.bd(rescaled.grunt_tree)
## optimize BiSSE model
grunt_bisse.mle<-find.mle(grunt_bisse.fn,starting_p)
grunt_bisse.mle
## print the parameter values alone
grunt_bisse.mle$par
## print the parameter values alone
round(grunt_bisse.mle$par,6)
getwd()
setwd("../Dropbox/courses/BIOL634-fall2025/biol634/")
list.files("ex")
list.files("ex/17")
