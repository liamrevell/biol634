x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,0.8*par()$usr[4],"threshold",srt=90)
text(0.1,0.8*par()$usr[4],"threshold",srt=90)
text(0.1,
0.8*diff(par()$usr[3:4])+par()$usr[3],"threshold",srt=90)
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
hist(y)
hist(y,breaks=20)
## compare histograms of y & estimated y
par(mfrow=c(2,1))
hist(y,breaks=20,main="histogram of true liabilities")
hist(est.y[1:Ntip(tree)],breaks=20,
main="histogram of estimated liabilities")
## compare histograms of y & estimated y
par(mfrow=c(2,1))
hist(y,breaks=20,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=20,
main="histogram of estimated liabilities",
xlab="estimated liability")
## simulate star-shaped tree
tree<-phytools:::lambdaTree(pbtree(n=100),0)
## simulate liabilities
y<-fastBM(tree)
## simulate threshold trait
x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
hist(y,breaks=20,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=20,
main="histogram of estimated liabilities",
xlab="estimated liability")
breaks<-seq(min(y),max(y),length.out=20)
breaks<-seq(min(y),max(y),length.out=20)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
## load phytools
library(phytools)
## simulate tree
tree<-pbtree(n=500)
## simulate liabilities
y<-fastBM(tree)
## simulate threshold trait
x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(min(y),max(y),length.out=30)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=30)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
fit$mk_fit
breaks<-seq(min(y),max(y),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(min(y),max(y),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
par(mfrow=c(2,1))
breaks<-seq(min(y),max(y),length.out=32)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
breaks
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=30)
breaks
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
breaks
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8,col="blue",lwd=2)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted")
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8,col="blue",lwd=2)
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
## load phytools
library(phytools)
## simulate tree
tree<-pbtree(n=500)
## simulate liabilities
y<-fastBM(tree)
## simulate threshold trait
x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
## now do the same thing without information about
## the liability (i.e., on a star tree)
## simulate star-shaped tree
tree<-phytools:::lambdaTree(pbtree(n=100),0)
## simulate liabilities
y<-fastBM(tree)
## simulate threshold trait
x<-as.factor(sapply(y,function(x) if(x<0) "a" else "b"))
## fit threshold model
fit<-fitThresh(tree,x,levs=100)
## apply ancr to fit$mk_fit object
object<-ancr(fit$mk_fit,tips=TRUE)
## graph the likelihood function for arbitrary tip
## (can change for any node)
tip<-1
par(mar=c(5.1,4.1,2.1,2.1))
ll<-log(object$ace[tip,])+logLik(fit)
plot(fit$liability,ll,type="s",bty="n",
xlab="liability",ylab="density",
ylim=c(max(ll)-3,max(ll))) #
grid()
abline(v=0,lty="dotted")
text(0.1,
0.9*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90)
## estimate tip liabilities
est.y<-fit$liability[apply(object$ace,1,
which.max)][1:Ntip(tree)]
## graph compared to generating liabilities
plot(y,est.y[1:Ntip(tree)],bty="n",pch=21,bg="grey",
xlab="simulated liability",
ylab="estimated liability")
abline(0,1,lwd=2,col="blue")
grid()
## compare histograms of y & estimated y
par(mfrow=c(2,1))
breaks<-seq(-max(abs(y)),max(abs(y)),length.out=31)
hist(y,breaks=breaks,main="histogram of true liabilities",
xlab="liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
hist(est.y[1:Ntip(tree)],breaks=breaks,
main="histogram of estimated liabilities",
xlab="estimated liability")
abline(v=0,lty="dotted",col="blue",lwd=2)
text(0.1,
0.85*diff(par()$usr[3:4])+par()$usr[3],
"threshold",srt=90,cex=0.8)
library(phytools)
data("elapidae.tree")
par(mfrow=c(2,1))
plotTree(elapidae.tree,ftype='i',fsize=0.6)
par(mfrow=c(2,1))
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1)
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1,
mar=c(2.1,4.1,1.1,1.1))
par(mfrow=c(2,1))
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1,
mar=c(2.1,4.1,1.1,1.1))
object<-ltt(elapidae.tree,plot=FALSE)
object
plot(object,mar=c(5.1,4.1,1.1,1.1),bty="n",las=1,log.lineages=FALSE)
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1,
mar=c(2.1,4.1,1.1,1.1))
pp<-get("last_plot.phylo",envir=.PlotPhyloEnv)
plot(object,mar=c(5.1,4.1,1.1,1.1),bty="n",las=1,log.lineages=FALSE,)
plot(object,mar=c(5.1,4.1,1.1,1.1),bty="n",las=1,log.lineages=FALSE,
xlim=pp$x.lim)
plotTree(elapidae.tree,ftype='i',fsize=0.4,lwd=1,
mar=c(2.1,4.1,1.1,1.1))
par(mar=c(5.1,4.1,1.1,1.1))
plot(object,mar=c(5.1,4.1,1.1,1.1),bty="n",las=1,log.lineages=FALSE,
xlim=pp$x.lim)
## load phytools
library(phytools)
## let's "prove" the pull-of-the-present
?pbtree
## we can figure out what net-diversification rate I need
## to get (say) 1,000 taxa after 100 ma.
## we need to solve 1000 = 2*exp(nd*100)
## ln(1000) = ln(2) + nd*100
## (ln(1000) - ln(2))/100 = nd
nd<-(log(1000)-log(2))/100
nd
mu<-lambda-nd
lambda<-0.1
mu<-lambda-nd
lambda
mu
## now let's simulate a tree
tree<-pbtree(b=lamba,d=mu,t=100)
## now let's simulate a tree
tree<-pbtree(b=lambba,d=mu,t=100)
## now let's simulate a tree
tree<-pbtree(b=lambda,d=mu,t=100)
tree
## plot this tree
plotTree(tree,lwd=1,ftype="off")
## generate a lineage through time plot
object<-ltt(tree,plot=FALSE)
dev.off()
plot(object)
## prune out all the extinct tips
?getExtinct
extantonly_tree<-drop.tip(tree,getExtinct(tree))
extantonly_tree
## plot my "reconstructed tree"
plotTree(extantonly_tree,ftype="off")
## plot my "reconstructed tree"
plotTree(extantonly_tree,ftype="off",lwd=1)
## recalculate my LTT plot
object<-ltt(extantonly_tree,plot=FALSE)
dev.off()
plot(object)
args(pbtree)
max(nodeHeights(extantonly_tree))
## create a pure-birth tree of the same total
## length & diversity
purebirth_tree<-pbtree(n=Ntip(extantonly_tree),
scale=max(nodeHeights(extantonly_tree)))
## generate an LTT plot for this
purebirth_tree.ltt<-ltt(purebirth_tree)
plot(object)
## generate an LTT plot for this
purebirth_tree.ltt<-ltt(purebirth_tree)
plot(object)
## we're going to a use a very simple phytools
## function to fit the birth-death model
bd_model<-fit.bd(extantonly_tree)
bd_model
## apply the same thing to our pure-birth tree
bd_model.purebirth<-fit.bd(purebirth_tree)
bd_model.purebirth
## we can test a hypothesis about this model
yule_model<-fit.yule(extantonly_tree)
yule_model
## compare models
anova(yule_model,bd_model)
## inspect the object from ltt
object
## read tree from website
elapidae_tree<-read.nexus(
file="https://liamrevell.github.io/biol634/data/elapidae.nex")
elapidae_tre
elapidae_tree
?fit.bd
Ntip(elapidae_tree)/nlow
## approximate number of total elapids
nlow<-300
nhigh<-360
Ntip(elapidae_tree)/nlow
## let's fit a birth-death model accounting for sampling fraction
elapid_bd.low<-fit.bd(elapidae_tree,
rho=Ntip(elapidae_tree)/nlow)
elapid_bd.low
elapid_bd.high<-fit.bd(elapidae_tree,
rho=Ntip(elapidae_tree)/nhigh)
elapid_bd.high
## we can fit the same model using diversitree
library(diversitree)
?make.bd
bd_lik.low<-make.bd(elapidae_tree,
sampling.f=Ntip(elapidae_tree)/nlow)
bd_lik.low
mle.bd_low<-find.mle(bd_lik.low,x.init=c(0.1,0))
mle.bd_lwo
mle.bd_low
mle.bd_low<-find.mle(bd_lik.low,x.init=c(0.2,0.05))
mle.bd_low
bd_lik.high<-make.bd(elapidae_tree,
sampling.f=Ntip(elapidae_tree)/nhigh)
bd_lik.high
mle.bd_high<-find.mle(bd_lik.high,x.init=c(0.2,0.05))
mle.bd_high
getwd()
setwd("courses/BIOL634-fall2025/")
setwd("biol634/")
?errorbar.contMap
tree
tree<-pbtree(n=10)
x<-fastBM(tree)
fit<-fastAnc(tree,x,CI=TRUE)
fit$ace
fit$CI95
class(fit)
?getMRCA
?findMRCA
plotTree(tree)
collapseTree
?collapseTree
get.treepos()
nodelabels()
get.treepos()
fastAnc(tree,x,CI=TRUE)$CI95
ace(tree,x)
ace(x,tree)
?ace
fastAnc
getwd()
setwd("data")
list.files()
list.files()
list.files()
